{% extends 'customer_web/base.html' %}
{% load static %}

{% block title %}S·∫£n ph·∫©m - KiKi{% endblock %}

{% block extra_css %}
<style>
@media (max-width: 767.98px) {
    .product-card .card-title {
        font-size: 0.9rem;
    }
    .product-card .card-text {
        font-size: 0.9rem;
    }
    .product-card .price {
        font-size: 0.9rem;
    }
    .product-card .btn {
        font-size: 0.9rem;
    }
    .product-card .badge {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> B·ªô l·ªçc</h5>
                </div>
                <div class="card-body">
                    <!-- Categories -->
                    <h6>Danh m·ª•c</h6>
                    <div class="mb-3" id="category-filters">
                        <button type="button"
                            class="btn btn-outline-secondary btn-sm mb-2 {% if not selected_categories %}active{% endif %}"
                            data-slug="all">
                            T·∫•t c·∫£
                        </button>
                        {% for category in categories %}
                        <button type="button"
                            class="btn btn-outline-secondary btn-sm mb-2 {% if category.slug in selected_categories %}active{% endif %}"
                            data-slug="{{ category.slug }}">
                            {{ category.name }}
                        </button>
                        {% endfor %}
                    </div>

                    
                    <!-- Sort -->
                    <h6>S·∫Øp x·∫øp</h6>
                    <select class="form-select" id="sort-select" onchange="updateSort(this.value)">
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>M·ªõi nh·∫•t</option>
                        <option value="trending" {% if sort_by == 'trending' %}selected{% endif %}>üî• Hot Trend</option>
                        <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Gi√° th·∫•p ƒë·∫øn cao</option>
                        <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Gi√° cao ƒë·∫øn th·∫•p</option>
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>T√™n A-Z</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Products -->
        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>S·∫£n ph·∫©m
                    {% if search_query %}
                    <small class="text-muted">- K·∫øt qu·∫£ t√¨m ki·∫øm: "{{ search_query }}"</small>
                    {% elif selected_categories %}
                    <small class="text-muted">- Danh m·ª•c: 
                        {% for category in categories %}
                            {% if category.slug in selected_categories %}
                                {{ category.name }}{% if not forloop.last %}, {% endif %}
                            {% endif %}
                        {% endfor %}
                    </small>
                    {% endif %}
                </h2>
                <span class="text-muted">{{ products.paginator.count }} s·∫£n ph·∫©m</span>
            </div>
            
            <div class="row g-4">
                {% for product in products %}
                <div class="col-lg-4 col-md-6 col-sm-6 col-6">
                    <div class="card product-card h-100">
                       {% with product.images.first as primary_image %}
                    {% if primary_image %}
                    <a href="{% url 'customer_web:product_detail' product.slug %}">
                        <img src="{{ primary_image.image.url }}" class="card-img-top" 
                             alt="{{ product.name }}" style="height: 250px; object-fit: cover; flex-shrink: 0;">
                    </a>
                    {% else %}
                    <a href="{% url 'customer_web:product_detail' product.slug %}">
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px; flex-shrink: 0;">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                    </a>
                    {% endif %}
                    {% endwith %}
                        
                        <div class="card-body d-flex flex-column">
                            {% if product.is_on_sale %}
                            <span class="badge bg-danger mb-2 align-self-start">Sale</span>
                            {% endif %}
                            
                            <h6 class="card-title">{{ product.name }}</h6>
                            <p class="card-text text-muted small flex-grow-1">
                                {{ product.description|truncatewords:15 }}
                            </p>
                            
                            <div class="price mb-3">
                                {% if product.is_on_sale %}
                                <span class="text-muted text-decoration-line-through me-2">
                                    {{ product.price|floatformat:0 }}‚Ç´
                                </span>
                                <span class="text-primary fw-bold h5">
                                    {{ product.discount_price|floatformat:0 }}‚Ç´
                                </span>
                                {% else %}
                                <span class="text-primary fw-bold h5">
                                    {{ product.price|floatformat:0 }}‚Ç´
                                </span>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid gap-2 mt-auto">
                                <a href="{% url 'customer_web:product_detail' product.slug %}" 
                                   class="btn btn-outline-primary btn-sm">
                                   <i class="fas fa-eye"></i> Xem chi ti·∫øt
                                </a>
                                <button onclick="showAddToCartModal({{ product.id }}, '{{ product.name|escapejs }}')" 
                                        class="btn btn-primary btn-sm">
                                    <i class="fas fa-cart-plus"></i> Th√™m v√†o gi·ªè
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h4>
                        <p class="text-muted">Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c xem t·∫•t c·∫£ s·∫£n ph·∫©m</p>
                        <a href="{% url 'customer_web:product_list' %}" class="btn btn-primary">
                            Xem t·∫•t c·∫£ s·∫£n ph·∫©m
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if products.has_other_pages %}
            <nav aria-label="Product pagination" class="mt-5">
                <ul class="pagination justify-content-center">
                    {% if products.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if selected_categories %}categories={{ selected_categories|join:',' }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ products.previous_page_number }}">
                            <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in products.paginator.page_range %}
                    {% if products.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if selected_categories %}categories={{ selected_categories|join:',' }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
                    
                    {% if products.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if selected_categories %}categories={{ selected_categories|join:',' }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if sort_by %}sort={{ sort_by }}&{% endif %}page={{ products.next_page_number }}">
                            Sau <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add to Cart Modal -->
<div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addToCartModalLabel">
                    <i class="fas fa-cart-plus me-2"></i>Th√™m v√†o gi·ªè h√†ng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-product-info">
                    <h6 id="modal-product-name"></h6>
                </div>
                
                <div class="mb-3">
                    <label for="modal-size" class="form-label">K√≠ch th∆∞·ªõc <span class="text-danger">*</span></label>
                    <select class="form-select" id="modal-size" required>
                        <option value="">-- Ch·ªçn k√≠ch th∆∞·ªõc --</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="modal-color" class="form-label">M√†u s·∫Øc</label>
                    <select class="form-select" id="modal-color">
                        <option value="">-- Ch·ªçn m√†u s·∫Øc --</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="modal-quantity" class="form-label">S·ªë l∆∞·ª£ng</label>
                    <input type="number" class="form-control" id="modal-quantity" value="1" min="1">
                </div>
                
                <div id="stock-info" class="text-muted small"></div>
                
                <!-- Hidden CSRF Token -->
                {% csrf_token %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="addToCartFromModal()">
                    <i class="fas fa-cart-plus me-1"></i>Th√™m v√†o gi·ªè h√†ng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Th√†nh c√¥ng!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h6>ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng th√†nh c√¥ng!</h6>
                <p class="text-muted">B·∫°n c√≥ mu·ªën xem gi·ªè h√†ng kh√¥ng?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Ti·∫øp t·ª•c mua s·∫Øm
                </button>
                <a href="{% url 'customer_web:cart' %}" class="btn btn-success">
                    <i class="fas fa-shopping-cart me-1"></i>Xem gi·ªè h√†ng
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateSort(sortBy) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('sort', sortBy);
    window.location.search = urlParams.toString();
}

document.addEventListener('DOMContentLoaded', function () {
    const buttons = document.querySelectorAll('#category-filters button');
    let selected = new Set({{ selected_categories|safe }}); // truy·ªÅn selected t·ª´ server v√†o JS n·∫øu c√≥

    buttons.forEach(button => {
        button.addEventListener('click', function () {
            const slug = this.dataset.slug;

            if (slug === "all") {
                // Ch·ªçn "T·∫•t c·∫£" -> b·ªè h·∫øt l·ª±a ch·ªçn
                selected.clear();
            } else {
                if (selected.has(slug)) {
                    selected.delete(slug);
                } else {
                    selected.add(slug);
                }
            }

            // C·∫≠p nh·∫≠t URL query string
            const queryParams = new URLSearchParams(window.location.search);
            
            // X√≥a search query khi click v√†o danh m·ª•c
            queryParams.delete('search');
            
            if (selected.size > 0) {
                queryParams.set('categories', Array.from(selected).join(','));
            } else {
                queryParams.delete('categories');
            }

            // Reload trang v·ªõi query m·ªõi
            window.location.search = queryParams.toString();
        });
    });
});

let currentProductId = null;

function showAddToCartModal(productId, productName) {
    currentProductId = productId;
    document.getElementById('modal-product-name').textContent = productName;
    
    // Reset form
    document.getElementById('modal-size').innerHTML = '<option value="">-- Ch·ªçn k√≠ch th∆∞·ªõc --</option>';
    document.getElementById('modal-color').innerHTML = '<option value="">-- Ch·ªçn m√†u s·∫Øc --</option>';
    document.getElementById('modal-quantity').value = 1;
    document.getElementById('stock-info').textContent = '';
    
    console.log('Loading variants for product:', productId);
    
    // Load product variants
    fetch(`/api/product/${productId}/inventory/`)
        .then(response => {
            console.log('API response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received variant data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'API returned error');
            }
            
            const sizeSelect = document.getElementById('modal-size');
            const colorSelect = document.getElementById('modal-color');
            
            if (!data.variants || data.variants.length === 0) {
                alert('S·∫£n ph·∫©m n√†y hi·ªán kh√¥ng c√≥ bi·∫øn th·ªÉ n√†o.');
                return;
            }
            
            // Populate sizes
            const sizes = [...new Set(data.variants.map(v => v.size).filter(s => s))];
            sizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            });
            
            // Populate colors
            const colors = [...new Set(data.variants.map(v => v.color).filter(c => c))];
            colors.forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                colorSelect.appendChild(option);
            });
            
            // Show modal
            new bootstrap.Modal(document.getElementById('addToCartModal')).show();
        })
        .catch(error => {
            console.error('Error loading product variants:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.');
        });
}

function updateStockInfo() {
    const size = document.getElementById('modal-size').value;
    const color = document.getElementById('modal-color').value;
    
    if (size && currentProductId) {
        console.log('Checking stock for:', { size, color, currentProductId });
        
        fetch(`/api/product/${currentProductId}/inventory/?size=${encodeURIComponent(size)}&color=${encodeURIComponent(color || '')}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Stock info received:', data);
                const stockInfo = document.getElementById('stock-info');
                
                if (data.success && data.inventory) {
                    if (data.inventory.quantity > 0) {
                        stockInfo.textContent = `C√≤n l·∫°i: ${data.inventory.quantity} s·∫£n ph·∫©m`;
                        stockInfo.className = 'text-success small';
                        
                        // Update max quantity
                        const quantityInput = document.getElementById('modal-quantity');
                        quantityInput.max = data.inventory.quantity;
                        if (parseInt(quantityInput.value) > data.inventory.quantity) {
                            quantityInput.value = data.inventory.quantity;
                        }
                    } else {
                        stockInfo.textContent = 'H·∫øt h√†ng';
                        stockInfo.className = 'text-danger small';
                    }
                } else {
                    stockInfo.textContent = 'Kh√¥ng c√≥ th√¥ng tin t·ªìn kho';
                    stockInfo.className = 'text-warning small';
                }
            })
            .catch(error => {
                console.error('Error checking stock:', error);
                const stockInfo = document.getElementById('stock-info');
                stockInfo.textContent = 'L·ªói khi ki·ªÉm tra t·ªìn kho';
                stockInfo.className = 'text-warning small';
            });
    }
}

function addToCartFromModal() {
    const size = document.getElementById('modal-size').value;
    const color = document.getElementById('modal-color').value;
    const quantity = document.getElementById('modal-quantity').value;
    
    console.log('Adding to cart:', { currentProductId, size, color, quantity });
    
    // Validate
    if (!size) {
        document.getElementById('modal-size').classList.add('is-invalid');
        alert('Vui l√≤ng ch·ªçn k√≠ch th∆∞·ªõc!');
        return;
    } else {
        document.getElementById('modal-size').classList.remove('is-invalid');
    }
    
    if (!currentProductId) {
        alert('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c s·∫£n ph·∫©m');
        return;
    }
    
    // Add to cart
    fetch('/add-to-cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: currentProductId,
            size: size,
            color: color || '',
            quantity: parseInt(quantity)
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Hide add to cart modal
            bootstrap.Modal.getInstance(document.getElementById('addToCartModal')).hide();
            
            // Show success modal
            new bootstrap.Modal(document.getElementById('successModal')).show();
            
            // Update cart badge
            const cartBadge = document.getElementById('cart-badge');
            if (cartBadge && data.cart_total_items) {
                cartBadge.textContent = data.cart_total_items;
                cartBadge.style.display = 'inline';
            }
        } else {
            alert(data.message || 'C√≥ l·ªói x·∫£y ra khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng');
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners after DOM is loaded
    const modalSize = document.getElementById('modal-size');
    const modalColor = document.getElementById('modal-color');
    
    if (modalSize) {
        modalSize.addEventListener('change', updateStockInfo);
    }
    if (modalColor) {
        modalColor.addEventListener('change', updateStockInfo);
    }
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>
{% endblock %}

{% extends 'customer_web/base.html' %}
{% load static %}
{% load money_filters %}

{% block title %}KiKi - Th·ªùi trang H√†n Qu·ªëc{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section position-relative overflow-hidden">
    <div class="hero-bg"></div>
    <div class="container">
        <div class="row align-items-center min-vh-75">
            <div class="col-lg-6 order-2 order-lg-1">
                <div class="hero-content">
                    <span class="badge bg-primary-soft text-primary px-3 py-2 mb-3 fs-6">
                        ‚ú® Collection 2025
                    </span>
                    <h1 class="display-3 fw-bold mb-4 text-gradient">
                        KiKi Kid's
                        <span class="text-primary"></span>
                    </h1>
                    <p class="lead mb-4 text-muted fs-5">
                        - Chuy√™n Th·ªùi Trang Tr·∫ª Em
                        <br>
                        - H√†ng Qu·∫£ng Ch√¢u/ H√†n Qu·ªëc/ Thi·∫øt K·∫ø
                        <br>
                        - Ch·∫•t l∆∞·ª£ng - Gi√° r·∫ª - C√≥ S·∫µn
                        <br>
                        - Lu√¥n c·∫≠p nh·∫≠t m·∫´u m√£ m·ªõi nh·∫•t
                    </p>
                    <div class="hero-stats mb-4">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stat-item">
                                    <img src="{% static 'customer_web/images/quality.jpg' %}" 
                                           alt="Ch·∫•t l∆∞·ª£ng" class="img-fluid mb-2" style="width: 200px; border-radius: 5px;">
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-item">
                                    <img src="{% static 'customer_web/images/fast-delivery.jpg' %}" 
                                           alt="Giao h√†ng nhanh" class="img-fluid mb-2" style="width: 200px; border-radius: 5px;">
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-item">
                                    <img src="{% static 'customer_web/images/rate.jpg' %}" 
                                           alt="ƒê√°nh gi√°" class="img-fluid mb-2" style="width: 200px; border-radius: 5px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hero-buttons" style="position: relative; z-index: 10;">
                        <a href="{% url 'customer_web:product_list' %}" class="btn btn-primary btn-lg px-3 py-3 me-3 fs-6" style="pointer-events: auto; position: relative; z-index: 10;" onclick="console.log('Button clicked!'); return true;">
                            <i class="fas fa-shopping-bag me-2"></i>
                            Mua s·∫Øm ngay
                        </a>
                        <a href="#categories" class="btn btn-outline-dark btn-lg px-4 py-3 fs-6" style="pointer-events: auto; position: relative; z-index: 10;">
                            <i class="fas fa-play-circle me-2"></i>
                            Kh√°m ph√°
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 order-1 order-lg-2">
                <div class="hero-image-container position-relative">
                    <!-- Main Hero Image -->
                    <div class="hero-main-image">
                        <img src="{% static 'customer_web/images/korean-fashion-hero.jpg' %}" 
                             class="img-fluid hero-img shadow-lg" 
                             alt="Korean Fashion 2025"
                             onerror="this.src='https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=600&h=700&fit=crop&crop=face'">
                    </div>
                    
                    <!-- Floating Cards -->
                    <div class="floating-card floating-card-1 position-absolute">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-3 text-center">
                                <i class="fas fa-shipping-fast text-primary mb-2"></i>
                                <small class="d-block fw-bold">Giao h√†ng nhanh</small>
                                <small class="text-muted">2-3 ng√†y</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="floating-card floating-card-2 position-absolute">
                    <div class="card border-0" style="background: transparent; box-shadow: none;">
                        <div class="card-body p-0 text-center">
                        <img src="/static/customer_web/images/discount.png" alt="Sale" class="img-fluid" style="max-height: 120px;">
                        </div>
                    </div>
                    </div>


                    
                    <!-- Decorative Elements -->
                    <div class="hero-decoration hero-decoration-1"></div>
                    <div class="hero-decoration hero-decoration-2"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scroll Indicator -->
    <div class="scroll-indicator position-absolute bottom-0 start-50 translate-middle-x mb-4">
        <a href="#categories" class="text-decoration-none">
            <div class="scroll-mouse">
                <div class="scroll-wheel"></div>
            </div>
            <small class="d-block text-center mt-2 text-muted">Cu·ªôn xu·ªëng</small>
        </a>
    </div>
</section>

<!-- Hot Trend Products Section -->
<section class="py-5" id="hot-trends">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="display-6 fw-bold text-gradient mb-3">
                üî• S·∫£n ph·∫©m Hot Trend
            </h2>
            <p class="lead text-muted">Nh·ªØng m√≥n ƒë·ªì ƒëang ƒë∆∞·ª£c sƒÉn l√πng nhi·ªÅu nh·∫•t</p>
        </div>
        <div class="row g-4">
            {% for product in hot_trend_products %}
            <div class="col-lg-3 col-md-6 col-6">
                <div class="card product-card h-100 d-flex flex-column position-relative">
                    <!-- Hot Badge -->
                    <span class="badge bg-danger position-absolute" style="top: 10px; left: 10px; z-index: 10; font-size: 0.7rem;">
                        üî• HOT
                    </span>
                    {% with product.images.first as primary_image %}
                    {% if primary_image %}
                    <a href="{% url 'customer_web:product_detail' product.slug %}">
                        <img src="{{ primary_image.image.url }}" class="card-img-top" 
                             alt="{{ product.name }}" style="height: 250px; object-fit: cover; flex-shrink: 0;">
                    </a>
                    {% else %}
                    <a href="{% url 'customer_web:product_detail' product.slug %}">
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px; flex-shrink: 0;">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                    </a>
                    {% endif %}
                    {% endwith %}
                    
                    <div class="card-body d-flex flex-column flex-grow-1">
                        <h6 class="card-title">{{ product.name|truncatechars:30 }}</h6>
                        <div class="price mb-2">
                            {% if product.is_on_sale %}
                            <span class="text-muted text-decoration-line-through me-2">
                                {{ product.price|currency_vnd }}
                            </span>
                            <span class="text-danger fw-bold">
                                {{ product.discount_price|currency_vnd }}
                            </span>
                            <span class="badge bg-warning text-dark ms-1">
                                -{{ product.discount_percentage }}%
                            </span>
                            {% else %}
                            <span class="text-primary fw-bold">
                                {{ product.price|currency_vnd }}
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Popularity indicators -->
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-fire text-danger"></i> ƒê√£ b√°n {{ product.sold_count|default:"100" }}+
                            </small>
                        </div>
                        
                        <div class="d-grid gap-2 mt-auto">
                            <a href="{% url 'customer_web:product_detail' product.slug %}" 
                               class="btn btn-outline-danger btn-sm">Xem chi ti·∫øt</a>
                            <button onclick="showAddToCartModal({{ product.id }}, '{{ product.name|escapejs }}')" 
                                    class="btn btn-danger btn-sm">
                                <i class="fas fa-cart-plus"></i> Th√™m v√†o gi·ªè
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center">
                <div class="py-5">
                    <i class="fas fa-fire fa-3x text-muted mb-3"></i>
                    <p class="text-muted fs-5">S·∫£n ph·∫©m hot trend ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</p>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="text-center mt-5">
            <a href="{% url 'customer_web:product_list' %}?sort=trending" class="btn btn-outline-danger btn-lg">
                <i class="fas fa-fire me-2"></i>
                Xem th√™m s·∫£n ph·∫©m hot trend
            </a>
        </div>
    </div>
</section>

<!-- Featured Products -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row align-items-center mb-5">
            <div class="col">
                <h2>S·∫£n ph·∫©m n·ªïi b·∫≠t</h2>
                <p class="text-muted">Nh·ªØng m√≥n ƒë·ªì hot nh·∫•t ƒë∆∞·ª£c y√™u th√≠ch</p>
            </div>
            <div class="col-auto">
                <a href="{% url 'customer_web:product_list' %}" class="btn btn-outline-primary">
                    Xem t·∫•t c·∫£ <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
        
        <div class="row g-4">
            {% for product in featured_products %}
            <div class="col-lg-3 col-md-6 col-6">
                <div class="card product-card h-100 d-flex flex-column">
                    {% with product.images.first as primary_image %}
                    {% if primary_image %}
                    <a href="{% url 'customer_web:product_detail' product.slug %}">
                        <img src="{{ primary_image.image.url }}" class="card-img-top" 
                             alt="{{ product.name }}" style="height: 250px; object-fit: cover; flex-shrink: 0;">
                    </a>
                    {% else %}
                    <a href="{% url 'customer_web:product_detail' product.slug %}">
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px; flex-shrink: 0;">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                    </a>
                    {% endif %}
                    {% endwith %}
                    
                    <div class="card-body d-flex flex-column flex-grow-1">
                        <h6 class="card-title">{{ product.name|truncatechars:30 }}</h6>
                        <div class="price mb-2">
                            {% if product.is_on_sale %}
                            <span class="text-muted text-decoration-line-through me-2">
                                {{ product.price|currency_vnd }}
                            </span>
                            <span class="text-primary fw-bold">
                                {{ product.discount_price|currency_vnd }}
                            </span>
                            {% else %}
                            <span class="text-primary fw-bold">
                                {{ product.price|currency_vnd }}
                            </span>
                            {% endif %}
                        </div>
                        <div class="d-grid gap-2 mt-auto">
                            <a href="{% url 'customer_web:product_detail' product.slug %}" 
                               class="btn btn-outline-primary btn-sm">Xem chi ti·∫øt</a>
                            <button onclick="showAddToCartModal({{ product.id }}, '{{ product.name|escapejs }}')" 
                                    class="btn btn-primary btn-sm">
                                <i class="fas fa-cart-plus"></i> Th√™m v√†o gi·ªè
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center">
                <p class="text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n·ªïi b·∫≠t n√†o.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- New Products -->
<section class="py-5">
    <div class="container">
        <div class="row align-items-center mb-5">
            <div class="col">
                <h2>S·∫£n ph·∫©m m·ªõi</h2>
                <p class="text-muted">Xu h∆∞·ªõng th·ªùi trang m·ªõi nh·∫•t t·ª´ H√†n Qu·ªëc</p>
            </div>
            <div class="col-auto">
                <a href="{% url 'customer_web:product_list' %}?sort=newest" class="btn btn-outline-secondary">
                    Xem t·∫•t c·∫£ <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
        
        <div class="row g-4">
            {% for product in new_products %}
            <div class="col-lg-3 col-md-6 col-6">
                <div class="card product-card h-100 d-flex flex-column">
                    {% with product.images.first as primary_image %}
                    {% if primary_image %}
                    <a href="{% url 'customer_web:product_detail' product.slug %}">
                        <img src="{{ primary_image.image.url }}" class="card-img-top" 
                             alt="{{ product.name }}" style="height: 250px; object-fit: cover; flex-shrink: 0;">
                    </a>
                    {% else %}
                    <a href="{% url 'customer_web:product_detail' product.slug %}">
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px; flex-shrink: 0;">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                    </a>
                    {% endif %}
                    {% endwith %}
                    
                    <div class="card-body d-flex flex-column flex-grow-1">
                        <span class="badge bg-success mb-2 align-self-start">M·ªõi</span>
                        <h6 class="card-title">{{ product.name|truncatechars:30 }}</h6>
                        <div class="price mb-2">
                            {% if product.is_on_sale %}
                            <span class="text-muted text-decoration-line-through me-2">
                                {{ product.price|currency_vnd }}
                            </span>
                            <span class="text-primary fw-bold">
                                {{ product.discount_price|currency_vnd }}
                            </span>
                            {% else %}
                            <span class="text-primary fw-bold">
                                {{ product.price|currency_vnd }}
                            </span>
                            {% endif %}
                        </div>
                        <div class="d-grid gap-2 mt-auto">
                            <a href="{% url 'customer_web:product_detail' product.slug %}" 
                               class="btn btn-outline-primary btn-sm">Xem chi ti·∫øt</a>
                            <button onclick="showAddToCartModal({{ product.id }}, '{{ product.name|escapejs }}')" 
                                    class="btn btn-primary btn-sm">
                                <i class="fas fa-cart-plus"></i> Th√™m v√†o gi·ªè
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center">
                <p class="text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m m·ªõi n√†o.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Featured News -->
{% if featured_news %}
<section class="py-5 bg-light">
    <div class="container">
        <div class="row align-items-center mb-5">
            <div class="col">
                <h2>Tin t·ª©c th·ªùi trang</h2>
                <p class="text-muted">C·∫≠p nh·∫≠t xu h∆∞·ªõng v√† th√¥ng tin m·ªõi nh·∫•t</p>
            </div>
            <div class="col-auto">
                <a href="{% url 'customer_web:news_list' %}" class="btn btn-outline-secondary">
                    Xem t·∫•t c·∫£ <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
        
        <div class="row g-4">
            {% for news in featured_news %}
            <div class="col-lg-4 col-md-6">
                <div class="card news-card h-100 shadow-sm">
                    {% if news.image %}
                    <a href="{% url 'customer_web:news_detail' news.slug %}">
                        <img src="{{ news.image.url }}" class="card-img-top" 
                             alt="{{ news.title }}" style="height: 200px; object-fit: cover;">
                    </a>
                    {% else %}
                    <a href="{% url 'customer_web:news_detail' news.slug %}">
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                             style="height: 200px;">
                            <i class="fas fa-newspaper fa-3x text-muted"></i>
                        </div>
                    </a>
                    {% endif %}
                    
                    <div class="card-body d-flex flex-column">
                        <span class="badge bg-info mb-2 align-self-start">Tin t·ª©c</span>
                        <h6 class="card-title">{{ news.title|truncatechars:50 }}</h6>
                        <p class="card-text text-muted flex-grow-1">
                            {{ news.summary|truncatewords:15|striptags }}
                        </p>
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> {{ news.created_at|date:"d/m/Y" }}
                                </small>
                                <small class="text-muted">
                                    <i class="fas fa-eye"></i> {{ news.views }}
                                </small>
                            </div>
                            <a href="{% url 'customer_web:news_detail' news.slug %}" 
                               class="btn btn-outline-primary btn-sm w-100">
                                ƒê·ªçc th√™m <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Newsletter -->
<section class="py-5 bg-primary text-white">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h3>ƒêƒÉng k√Ω nh·∫≠n tin</h3>
                <p>Nh·∫≠n th√¥ng tin v·ªÅ s·∫£n ph·∫©m m·ªõi v√† khuy·∫øn m√£i ƒë·∫∑c bi·ªát</p>
            </div>
            <div class="col-lg-6">
                <div class="row g-2">
                    <div class="col">
                        <input type="email" class="form-control" placeholder="Email c·ªßa b·∫°n...">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-light">ƒêƒÉng k√Ω</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add to Cart Modal -->
<div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addToCartModalLabel">
                    <i class="fas fa-cart-plus me-2"></i>Th√™m v√†o gi·ªè h√†ng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-product-info">
                    <h6 id="modal-product-name"></h6>
                </div>
                
                <div class="mb-3">
                    <label for="modal-size" class="form-label">Ch·ªçn k√≠ch th∆∞·ªõc <span class="text-danger">*</span></label>
                    <select class="form-select" id="modal-size" required>
                        <option value="">-- Ch·ªçn k√≠ch th∆∞·ªõc --</option>
                    </select>
                    <div class="invalid-feedback">Vui l√≤ng ch·ªçn k√≠ch th∆∞·ªõc</div>
                </div>
                
                <div class="mb-3">
                    <label for="modal-color" class="form-label">Ch·ªçn m√†u s·∫Øc</label>
                    <select class="form-select" id="modal-color">
                        <option value="">-- Ch·ªçn m√†u s·∫Øc --</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="modal-quantity" class="form-label">S·ªë l∆∞·ª£ng</label>
                    <input type="number" class="form-control" id="modal-quantity" value="1" min="1" max="10">
                </div>
                
                <div id="stock-info" class="text-muted small"></div>
                
                <!-- Hidden CSRF Token -->
                {% csrf_token %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="addToCartFromModal()">
                    <i class="fas fa-cart-plus me-2"></i>Th√™m v√†o gi·ªè
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Th√†nh c√¥ng!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h6>ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng th√†nh c√¥ng!</h6>
                <p class="text-muted">B·∫°n c√≥ mu·ªën xem gi·ªè h√†ng kh√¥ng?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Ti·∫øp t·ª•c mua s·∫Øm
                </button>
                <a href="{% url 'customer_web:cart' %}" class="btn btn-primary">
                    <i class="fas fa-shopping-cart me-2"></i>Xem gi·ªè h√†ng
                </a>
            </div>
        </div>
    </div>
</div>

<style>
/* Fix button clickability issues */
.hero-buttons {
    position: relative !important;
    z-index: 100 !important;
}

.hero-buttons a {
    position: relative !important;
    z-index: 101 !important;
    pointer-events: auto !important;
    display: inline-block !important;
}

.hero-section .hero-bg {
    pointer-events: none !important;
}

.hero-decoration {
    pointer-events: none !important;
}

.hero-img {
    border-radius: 20px;
    transform: rotate(2deg);
    transition: transform 0.3s ease;
    max-height: 600px;
    width: 100%;
    object-fit: cover;
}
.hero-img:hover {
    transform: rotate(0deg) scale(1.02);
}

/* Enhanced Hero Section */
.hero-section {
    background: linear-gradient(135deg, #ffffffff 0%, #ffffffff 100%);
    min-height: 80vh;
}
        
.hero-bg {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="%23ff6b9d15" points="0,1000 1000,1000 1000,200 0,600"/><polygon fill="%234ecdc415" points="0,800 1000,400 1000,0 0,0"/></svg>') no-repeat center center;
    background-size: cover;
    opacity: 0.3;
}
.hero-content {
    animation: slideInLeft 1s ease-out;
}

.hero-image-container {
    animation: slideInRight 1s ease-out;
}

.hero-decoration {
    position: absolute;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    opacity: 0.2;
}
        
.hero-decoration-1 {
    width: 200px;
    height: 200px;
    top: -50px;
    right: -50px;
    animation: rotate 20s linear infinite;
}

.hero-decoration-2 {
    width: 150px;
    height: 150px;
    bottom: -30px;
    left: -30px;
    animation: rotate 15s linear infinite reverse;
}
.hero-buttons .btn {
    width: 166px;
    border-radius: 50px;
    font-weight: 300;
    transition: all 0.3s ease;
}

.hero-buttons .btn:hover {
    transform: translateY(-2px);
}

@media(max-width: 576px){
    .hero-img {
        border-radius: 20px;
        transform: rotate(0deg);
        transition: transform 0.3s ease;
        max-height: 600px;
        width: 100%;
        object-fit: cover;
    }
    .hero-decoration-2 {
        width: 76px;
        height: 69px;
        bottom: -133px;
        left: 267px;
        animation: rotate 15s linear infinite reverse;
    }
}

.floating-card {
    pointer-events: none !important;
}

/* Make all product cards equal height */
.product-card.h-100 {
    height: 100% !important;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.product-card .card-body {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
}

.product-card .card-text {
    flex-grow: 1 !important;
    min-height: 60px;
}

.product-card .mt-auto {
    margin-top: auto !important;
}

/* Hot trend product styling */
#hot-trends .product-card {
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

#hot-trends .product-card:hover {
    border-color: #dc3545;
    transform: translateY(-8px) scale(1.02);
}

#hot-trends .badge {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Ensure consistent card heights across all sections */
@media (max-width: 576px) {
    .product-card .card-body {
        padding: 1rem 0.75rem;
    }
    
    .product-card .card-title {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .product-card .card-text {
        font-size: 0.85rem;
        min-height: 50px;
    }
    
    .product-card .btn {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
    }
    
    .product-card img,
    .product-card .card-img-top {
        height: 150px !important;
    }
}
</style>

<script>
let currentProductId = null;

function showAddToCartModal(productId, productName) {
    currentProductId = productId;
    document.getElementById('modal-product-name').textContent = productName;
    
    // Reset form
    document.getElementById('modal-size').innerHTML = '<option value="">-- Ch·ªçn k√≠ch th∆∞·ªõc --</option>';
    document.getElementById('modal-color').innerHTML = '<option value="">-- Ch·ªçn m√†u s·∫Øc --</option>';
    document.getElementById('modal-quantity').value = 1;
    document.getElementById('stock-info').textContent = '';
    
    console.log('Loading variants for product:', productId);
    
    // Load product variants
    fetch(`/api/product/${productId}/inventory/`)
        .then(response => {
            console.log('API response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received variant data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'API returned error');
            }
            
            const sizeSelect = document.getElementById('modal-size');
            const colorSelect = document.getElementById('modal-color');
            
            if (!data.variants || data.variants.length === 0) {
                alert('S·∫£n ph·∫©m n√†y hi·ªán kh√¥ng c√≥ bi·∫øn th·ªÉ n√†o.');
                return;
            }
            
            // Populate sizes
            const sizes = [...new Set(data.variants.map(v => v.size).filter(s => s))];
            sizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            });
            
            // Populate colors
            const colors = [...new Set(data.variants.map(v => v.color).filter(c => c))];
            colors.forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                colorSelect.appendChild(option);
            });
            
            // Show modal
            new bootstrap.Modal(document.getElementById('addToCartModal')).show();
        })
        .catch(error => {
            console.error('Error loading product variants:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.');
        });
}

function updateStockInfo() {
    const size = document.getElementById('modal-size').value;
    const color = document.getElementById('modal-color').value;
    
    if (size && currentProductId) {
        console.log('Checking stock for:', { size, color, currentProductId });
        
        fetch(`/api/product/${currentProductId}/inventory/?size=${encodeURIComponent(size)}&color=${encodeURIComponent(color || '')}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Stock info received:', data);
                const stockInfo = document.getElementById('stock-info');
                
                if (data.success) {
                    if (data.quantity > 0) {
                        stockInfo.innerHTML = `<i class="fas fa-check text-success"></i> C√≤n ${data.quantity} s·∫£n ph·∫©m`;
                        stockInfo.className = 'text-success small';
                        document.getElementById('modal-quantity').max = data.quantity;
                    } else {
                        stockInfo.innerHTML = `<i class="fas fa-times text-danger"></i> H·∫øt h√†ng`;
                        stockInfo.className = 'text-danger small';
                        document.getElementById('modal-quantity').max = 0;
                    }
                } else {
                    stockInfo.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> Kh√¥ng c√≥ th√¥ng tin t·ªìn kho`;
                    stockInfo.className = 'text-warning small';
                }
            })
            .catch(error => {
                console.error('Error checking stock:', error);
                const stockInfo = document.getElementById('stock-info');
                stockInfo.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> Kh√¥ng th·ªÉ ki·ªÉm tra t·ªìn kho`;
                stockInfo.className = 'text-warning small';
            });
    }
}

function addToCartFromModal() {
    const size = document.getElementById('modal-size').value;
    const color = document.getElementById('modal-color').value;
    const quantity = document.getElementById('modal-quantity').value;
    
    console.log('Adding to cart:', { currentProductId, size, color, quantity });
    
    // Validate
    if (!size) {
        document.getElementById('modal-size').classList.add('is-invalid');
        alert('Vui l√≤ng ch·ªçn k√≠ch th∆∞·ªõc!');
        return;
    } else {
        document.getElementById('modal-size').classList.remove('is-invalid');
    }
    
    if (!currentProductId) {
        alert('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c s·∫£n ph·∫©m');
        return;
    }
    
    // Add to cart
    fetch('/add-to-cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: currentProductId,
            size: size,
            color: color || '',
            quantity: parseInt(quantity)
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Hide add to cart modal
            bootstrap.Modal.getInstance(document.getElementById('addToCartModal')).hide();
            
            // Show success modal
            new bootstrap.Modal(document.getElementById('successModal')).show();
            
            // Update cart badge (correct ID)
            const cartBadge = document.getElementById('cart-badge');
            if (cartBadge && data.cart_total_items) {
                cartBadge.textContent = data.cart_total_items;
            }
        } else {
            alert(data.message || 'C√≥ l·ªói x·∫£y ra khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng');
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
    });
}

// Event listeners
document.getElementById('modal-size').addEventListener('change', updateStockInfo);
document.getElementById('modal-color').addEventListener('change', updateStockInfo);

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
